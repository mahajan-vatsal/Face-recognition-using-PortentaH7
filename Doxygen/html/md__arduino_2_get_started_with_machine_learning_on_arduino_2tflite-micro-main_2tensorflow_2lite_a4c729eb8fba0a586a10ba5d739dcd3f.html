<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Machine Vision using Portenta H7: 002_16x8_quantization_port</title>
<link rel="icon" href="logo.png" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Machine Vision using Portenta H7<span id="projectnumber">&#160;2</span>
   </div>
   <div id="projectbrief">This project aims to develop a face recognition-based access control system using the Arduino Portenta H7 and Vision Shield, leveraging Edge Impulse for machine learning. The system captures facial images, processes them locally using an AI model deployed on the Portenta H7 and determines access based on authorised personnel.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">002_16x8_quantization_port</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md241"></a>
TensorFlow Lite for Microcontrollers Port of 16x8 Quantized Operators</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Status   </th><th class="markdownTableHeadLeft">Proposed    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>RFC #2</b>   </td><td class="markdownTableBodyLeft"><a href="https://github.com/tensorflow/tensorflow/pull/46767">46767</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>Author(s)</b>   </td><td class="markdownTableBodyLeft">Daniel Situnayake (<a href="#" onclick="location.href='mai'+'lto:'+'dan'+'@e'+'dge'+'im'+'pul'+'se'+'.co'+'m'; return false;">dan@e<span class="obfuscator">.nosp@m.</span>dgei<span class="obfuscator">.nosp@m.</span>mpuls<span class="obfuscator">.nosp@m.</span>e.co<span class="obfuscator">.nosp@m.</span>m</a>)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>Sponsor</b>   </td><td class="markdownTableBodyLeft">Pete Warden (<a href="#" onclick="location.href='mai'+'lto:'+'pet'+'ew'+'ard'+'en'+'@go'+'og'+'le.'+'co'+'m'; return false;">petew<span class="obfuscator">.nosp@m.</span>arde<span class="obfuscator">.nosp@m.</span>n@goo<span class="obfuscator">.nosp@m.</span>gle.<span class="obfuscator">.nosp@m.</span>com</a>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>Updated</b>   </td><td class="markdownTableBodyLeft">2021-01-28   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md242"></a>
Objective</h2>
<p>TensorFlow Lite has kernel implementations that support 8 bit quantized weights but use 16 bit activations. We wish to port these implementations to TensorFlow Lite for Microcontrollers. The increased precision available for activations can improve performance for some quantized models.</p>
<p>Arm have agreed to support the initiative by adding the necessary 16x8 APIs to CMSIS-NN and porting the CMSIS-NN kernels.</p>
<h3><a class="anchor" id="autotoc_md243"></a>
Goals</h3>
<ul>
<li>Port a subset of 16x8 reference kernels from TensorFlow Lite to TensorFlow Lite Micro</li>
<li>Avoid increasing default code size or arena size of TensorFlow Lite Micro</li>
<li>Lay the groundwork for creating a CMSIS-NN port of the 16x8 kernels</li>
</ul>
<h3><a class="anchor" id="autotoc_md244"></a>
Non-goals</h3>
<ul>
<li>Port every single operator to 16x8; we only plan to port a subset of those with existing reference implementations</li>
</ul>
<h2><a class="anchor" id="autotoc_md245"></a>
Motivation</h2>
<p>Some networks that suffer unacceptable degradation when quantized with 8 bit weights and 8 bit activations perform adequately when quantized with 8 bit weights and 16 bit activations. The <a href="https://www.tensorflow.org/lite/performance/post_training_integer_quant_16x8">TensorFlow Lite documentation</a> states the following:</p>
<blockquote class="doxtable">
<p>&zwj;[16x8 quantization] mode can improve accuracy of the quantized model significantly, when activations are sensitive to the quantization, while still achieving almost 3-4x reduction in model size. Moreover, this fully quantized model can be consumed by integer-only hardware accelerators. </p>
</blockquote>
<p>Edge Impulse, a company that deploys TensorFlow Lite for Microcontrollers as part of its embedded machine learning pipeline, has gathered feedback from customers with production models for which 8 bit quantization results in unacceptable degradation but for whom 16x8 is fine.</p>
<p>While 16x8 quantization is well supported within TensorFlow Lite, it is not currently supported within TensorFlow Lite for Microcontrollers. Porting the TensorFlow Lite reference kernels is relatively straightforward and will improve adoption of TensorFlow Lite for Microcontrollers with users for whom degradation is too severe with full 8 bit quantization.</p>
<h2><a class="anchor" id="autotoc_md246"></a>
User Benefit</h2>
<p>The headline would be "16x8 kernels improve accuracy for quantized models on microcontrollers without
increasing model size".</p>
<p>Users would benefit in the following ways:</p>
<ul>
<li>Improved accuracy for quantized models without increasing model size (in exchange for additional runtime memory usage)</li>
<li>Improved performance under certain conditions (for example, 16x8 CMSIS-NN kernels will run faster) than 8 bit kernels since less unpacking is required)</li>
</ul>
<h2><a class="anchor" id="autotoc_md247"></a>
Design Proposal</h2>
<p>We propose that the 16x8 kernels are ported from the TensorFlow Lite reference kernels to TensorFlow Lite for Microcontrollers following the process in the <a href="https://docs.google.com/document/d/1KLJTPWm4TUKB9YyIqFJl9VCP0ZMJDt_P8RNpRmwqMxw/edit#heading=h.5x0d5h95i329">Porting TensorFlow Lite Ops to Micro</a> guide.</p>
<p>We wish to ensure that the following kernels are compatible with 16x8 mode:</p>
<ul>
<li>Conv2D</li>
<li>MaxPool2D</li>
<li>DepthwiseConv2D</li>
<li>FullyConnected</li>
<li>Relu</li>
<li>Relu6</li>
<li>Tanh</li>
<li>Softmax</li>
<li>Pad</li>
<li>Reshape</li>
<li>Pack</li>
<li>Unpack</li>
<li>Add</li>
<li>Mul</li>
</ul>
<p>Adding the 16x8 kernels directly to TFLM alongside the existing kernels would increase the default code size by an unacceptable amount. Instead, we will make use of the kernel registration API currently under development by the TFLM team. The use of this is demonstrated in the <a href="https://github.com/tensorflow/tensorflow/blob/a30d20b632b4ffbfd437ccf8ee205fef0917a3eb/tensorflow/lite/micro/benchmarks/keyword_benchmark.cc#L56">Keyword benchmark code</a>. By doing this, the end user can decide which kernels and dependencies they want to include (e.g. 8 bit, 16x8, or float32).</p>
<p>For example, the following could be registered:</p>
<div class="fragment"><div class="line">// Support for all datatypes</div>
<div class="line">op_resolver-&gt;AddFullyConnected(tflite::Register_FULLY_CONNECTED);</div>
<div class="line">// Support for 8 bit quantized models</div>
<div class="line">op_resolver-&gt;AddFullyConnected(tflite::Register_FULLY_CONNECTED_INT8);</div>
<div class="line">// Support for 16x8 quantized models</div>
<div class="line">op_resolver-&gt;AddFullyConnected(tflite::Register_FULLY_CONNECTED_INT16X8());</div>
</div><!-- fragment --><p>This means that kernels not currently using this registration API will need to be refactored to use it. Currently only <b>FullyConnected</b> uses the API.</p>
<p>The following associated tasks will be required to support this work:</p>
<ul>
<li>Build or port unit tests for the new kernels</li>
<li>Prove that code memory is not impacted by running benchmarks before and after the port</li>
</ul>
<h3><a class="anchor" id="autotoc_md248"></a>
Alternatives Considered</h3>
<ul>
<li>An alternative would be to add the 16x8 kernels without using the new kernel registration API, but this would result in a major increase in code size.</li>
</ul>
<h3><a class="anchor" id="autotoc_md249"></a>
Performance Implications</h3>
<ul>
<li>Impact on memory usage for current modes (int8 and float32) will be minimal. This will be confirmed by benchmarking of current performance against performance of the submitted changes.</li>
<li>When 16x8 mode is used, RAM usage will be approximately 2x. Latency may change depending on the target platform.</li>
<li>End to end and unit tests will be updated to prove that the new implementations are operating correctly.</li>
</ul>
<h3><a class="anchor" id="autotoc_md250"></a>
Dependencies</h3>
<ul>
<li>No additional dependencies will be added to TensorFlow</li>
<li>No other parts of TensorFlow will be affected</li>
</ul>
<h3><a class="anchor" id="autotoc_md251"></a>
Engineering Impact</h3>
<ul>
<li>Impact on binary size should be minimal</li>
<li>Test times may increase due to additional kernel unit tests</li>
<li>The reference kernels already exist within TensorFlow Lite so there will be minimal additional maintenance</li>
</ul>
<h3><a class="anchor" id="autotoc_md252"></a>
Platforms and Environments</h3>
<ul>
<li>The proposed changes will work on all currently supported platforms</li>
</ul>
<h3><a class="anchor" id="autotoc_md253"></a>
Best Practices</h3>
<ul>
<li>TensorFlow Lite for Microcontrollers should be updated to indicate that 16x8 kernels are now available</li>
</ul>
<h3><a class="anchor" id="autotoc_md254"></a>
Tutorials and Examples</h3>
<ul>
<li>A benchmark will be added to <a href="https://github.com/tensorflow/tensorflow/tree/975335bc83bf3cb80a71a04ed407725508709808/tensorflow/lite/micro/benchmarks"><code>tensorflow/lite/micro/benchmarks</code></a> that demonstrates the use of the ops that provide a 16x8 kernel.</li>
<li>A Colab will be created that demonstrates quantizing a model in 16x8 mode and exporting it as a C header file for use with TensorFlow Lite for Microcontrollers</li>
</ul>
<h3><a class="anchor" id="autotoc_md255"></a>
Compatibility</h3>
<ul>
<li>This work will improve compatibility and feature parity between TensorFlow Lite and TensorFlow Lite for Microcontrollers</li>
</ul>
<h3><a class="anchor" id="autotoc_md256"></a>
User Impact</h3>
<ul>
<li>Since TFLM does not have a versioning system the feature can be rolled out as any other commit</li>
</ul>
<h2><a class="anchor" id="autotoc_md257"></a>
Implementation plan</h2>
<p>The work will be broken down into a series of pull requests, some for the benchmarks and some for each kernel.</p>
<p>Benchmark pull requests:</p><ul>
<li>PR1: Create a new benchmark in <a href="https://github.com/tensorflow/tensorflow/tree/975335bc83bf3cb80a71a04ed407725508709808/tensorflow/lite/micro/benchmarks"><code>tensorflow/lite/micro/benchmarks</code></a> that attempts to run a 16x8 model that includes the kernels mentioned in this RFC. The model’s weights and biases can be random. The benchmark should use the MicroMutableOpResolver. The PR should include the Colab used to generate the model.</li>
<li>PR2: Port the person_detection and keyword benchmarks to use the MicroMutableOpResolver.</li>
<li>PR3: Add code to both benchmarks that prints the arena size using the <a href="https://github.com/tensorflow/tensorflow/blob/ee87d58a6504375c28f21ea303f0eefa29118c38/tensorflow/lite/micro/docs/memory_management.md#recording-memory-apis"><code>RecordingMemoryAllocator</code></a>.</li>
</ul>
<p>For each kernel:</p><ul>
<li>PR1: Refactor the implementation to support the new kernel variant registration API.</li>
<li>PR2: Add 16x8 support and make sure that the benchmark binary and arena sizes are unchanged.</li>
</ul>
<p>Note that @njeffrie from the TF Lite Micro team also plans to prepare PR(s) for the kernels that are of interest internally (without using the kernel variant registation API for binary size). This will provide some quick examples of porting the kernels.</p>
<h2><a class="anchor" id="autotoc_md258"></a>
Questions and Discussion Topics</h2>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>

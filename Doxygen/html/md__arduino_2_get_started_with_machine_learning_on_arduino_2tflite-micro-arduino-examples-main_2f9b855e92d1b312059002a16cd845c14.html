<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Machine Vision using Portenta H7: Test-Over-Serial support module</title>
<link rel="icon" href="logo.png" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Machine Vision using Portenta H7<span id="projectnumber">&#160;2</span>
   </div>
   <div id="projectbrief">This project aims to develop a face recognition-based access control system using the Arduino Portenta H7 and Vision Shield, leveraging Edge Impulse for machine learning. The system captures facial images, processes them locally using an AI model deployed on the Portenta H7 and determines access based on authorised personnel.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Test-Over-Serial support module</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md53"></a></p>
<p>This support module allows for testing of <a href="https://www.tensorflow.org/lite/microcontrollers">Tensorflow Lite Micro</a> (TFLM) Arduino <a href="/examples">examples</a> without the use of board specific peripherals (cameras, microphones, etc). All data necessary to conduct an inference operation by the example application is supplied over the Arduino serial interface.</p>
<p>Currently supported TFLM example applications are:</p><ul>
<li>person_detection</li>
<li>micro_speech</li>
</ul>
<h1><a class="anchor" id="autotoc_md54"></a>
Table of contents</h1>
<ul>
<li>Overview</li>
<li>Required serial interface support</li>
<li>Commands</li>
<li>C++ API<ul>
<li>Input handler callback</li>
</ul>
</li>
<li>Testing with test_over_serial.py script<ul>
<li>Linux and ModemManager</li>
<li>Example test configuration data</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md55"></a>
Overview</h1>
<p>The Arduino TFLM example application executes the normal inference operation using data from the board specific peripherals. When commanded over the serial interface to enter test mode, normal inference operations are halted. The example application remains in test mode awaiting data to arrive over the serial interface. When sufficient data is available, an inference operation is run. The example application then remains in test mode awaiting the next set of data from the serial interface.</p>
<p>This module does not interfere with the example application sending output to the serial interface. Thus the application can continue to have debug or other output. This module will consume all serial input once test mode is active.</p>
<h1><a class="anchor" id="autotoc_md56"></a>
Required serial interface support</h1>
<p>For the Test-Over-Serial module to work, serial interface access is required using a light-weight API. The header file <a href="/src/tensorflow/lite/micro/system_setup.h">system_setup.h</a> declares the API, and <a href="/src/tensorflow/lite/micro/system_setup.cpp">system_setup.cpp</a> provides the board specific implementation of the API.</p>
<p>Each line (command or data or response) sent over the serial interface must be newline (&lsquo;&rsquo;<br  />
'`) terminated.</p>
<p>No 3rd party Arduino libraries are required to use the Test-Over-Serial support module.</p>
<h1><a class="anchor" id="autotoc_md57"></a>
Commands</h1>
<p>The Test-Over-Serial support module recognizes to the following commands received over the serial interface:</p><ul>
<li><b>!TEST</b> Notification that the test mode has started. The application should cease all inference operations and await test data. The response to this command is <b>!OK TEST <em>max-binary-data-per-line</em></b>.<ul>
<li>The <code>max-binary-data-per-line</code> parameter is the maximum number of bytes of binary data to base-64 encode per line sent over the serial interface</li>
</ul>
</li>
<li><b>!DATA <em>data-type</em> &#160;<em>binary-data-size</em></b> Notification of the start of the data transfer. When all data is received, the <b>!OK DATA <em>data-type</em> &#160;<em>binary-data-size</em></b> response is sent. After each line of data received, the <b>!DATA_ACK <em>bytes-received</em></b> response is sent. Binary data must be base-64 encoded before being sent over the serial interface.<ul>
<li>The <code>binary-data-size</code> parameter is always in units of bytes</li>
<li>The <code>data-type</code> parameter specifies the type of data (audio, image, etc.)</li>
<li>The <code>bytes-received</code> parameter is the number of bytes of base-64 decoded binary data received</li>
</ul>
</li>
</ul>
<p>Any failure condition detected by the module is responded to by sending <b>!FAIL <em>command-that-failed</em></b>.</p>
<h1><a class="anchor" id="autotoc_md58"></a>
C++ API</h1>
<p>An example application can make use of the Test-Over-Serial module through the <a href="/src/test_over_serial/test_over_serial.h">C++ API</a>:</p><ul>
<li><code>TestOverSerial&amp; Instance(const TestDataType data_type)</code> Returns an instance of the <code>TestOverSerial</code> class. This class is a singleton.<ul>
<li><code>data_type</code> is the type of data the application wants to receive (audio, image, etc.)</li>
</ul>
</li>
<li><code>bool IsTestMode(void)</code> Returns <code>true</code> if the <code>!TEST</code> command has been received.</li>
<li><code>void ProcessInput(const InputHandler*)</code> The serial interface input processor. All commands and data received over the serial interface are responded to by this routine. When receiving data, for each line received, the <code>InputHandler</code> callback is executed.</li>
</ul>
<h2><a class="anchor" id="autotoc_md59"></a>
Input handler callback</h2>
<p>The <code>InputHandler</code> callback is used for application specific handling of received data. A single parameter is passed to the callback, a pointer to the following data structure: </p><div class="fragment"><div class="line">struct InputBuffer {</div>
<div class="line">  DataPtr data;   // input buffer pointer</div>
<div class="line">  size_t length;  // input buffer length</div>
<div class="line">  size_t offset;  // offset from start of input</div>
<div class="line">  size_t total;   // total data that will be transferred</div>
<div class="line">};</div>
</div><!-- fragment --><p> All members of this data structure will have values in units of the <code>data-type</code>. For example, 16-bit mono audio data will consist of 2 bytes per audio <code>sample</code>. The units of all values in the data structure would therefore be a count of <code>sample(s)</code>, not bytes.</p>
<p>The input buffer data will have been base-64 decoded prior to the <code>InputHandler</code> callback being executed.</p>
<p>The <code>InputHandler</code> callback must return <code>true</code> to allow data transfer to continue. Returning <code>false</code> will abort the data transfer and a <code>!FAIL DATA...</code> response will be sent to the serial interface.</p>
<h1><a class="anchor" id="autotoc_md60"></a>
Testing with test_over_serial.py script</h1>
<p>The <a href="/scripts/test_over_serial.py">test_over_serial.py</a> script is provided for automated testing of the supported Arduino example applications.</p>
<p>Only the <code>--example</code> option is required, which specifies which example application to test. The <code>--verbose</code> option controls the amount of output seen. The <code>--verbose</code> values can be:</p><ul>
<li><code>all</code> See all output including any output sent by the Arduino application</li>
<li><code>test</code> Restrict output to just the test results</li>
</ul>
<p>Example command line (must be run from the top of the tflite-micro-arduino-examples repository directory): </p><div class="fragment"><div class="line">tflite-micro-arduino-examples$ python3 scripts/test_over_serial.py --example person_detection --verbose test</div>
<div class="line">10:21:03.746946  Test start:</div>
<div class="line">10:21:04.016295  Test #1 for label &lt;person&gt; file &lt;person.bmp&gt;</div>
<div class="line">10:21:05.280497  Test #1 FAILED</div>
<div class="line">10:21:05.280648  Waiting 4.0s before next test</div>
<div class="line">10:21:09.288489  Test #2 for label &lt;no person&gt; file &lt;no_person.bmp&gt;</div>
<div class="line">10:21:10.550045  Test #2 PASSED</div>
<div class="line">10:21:10.550116  Waiting 4.0s before next test</div>
<div class="line">10:21:14.556783  Test #3 for label &lt;person&gt; file &lt;person.bmp&gt;</div>
<div class="line">10:21:16.328190  Test #3 PASSED</div>
<div class="line">10:21:16.328250  Waiting 4.0s before next test</div>
<div class="line">10:21:20.334084  Test #4 for label &lt;no person&gt; file &lt;no_person.bmp&gt;</div>
<div class="line">10:21:22.115927  Test #4 PASSED</div>
<div class="line">10:21:22.222481  Test end: total 4 completed 4 passed 3 failed 1</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md61"></a>
Linux and <code>ModemManager</code></h2>
<p>If <code>!TEST</code> command timeouts are seen when running the test script, it may be that <code>ModemManager</code> is interfering with the serial interface. <code>ModemManager</code> will need to be disabled or removed.</p>
<p>To disable (Ubuntu Linux): </p><div class="fragment"><div class="line">systemctl disable ModemManager.service</div>
<div class="line">systemctl stop ModemManager.service</div>
</div><!-- fragment --><p>To remove (Ubuntu Linux): </p><div class="fragment"><div class="line">sudo apt-get purge modemmanager</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md62"></a>
Example test configuration data</h2>
<p>The test script relies on configuration data in a JSON compatible form. The default configuration file name is <code>serial_test_config.json</code> and must be located within the <code>data</code> sub-directory of the example source code. An example configuration: </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;data type&quot;: &quot;image-grayscale&quot;,</div>
<div class="line">    &quot;delay after&quot;: 4.0,</div>
<div class="line">    &quot;test data&quot;: [</div>
<div class="line">        {</div>
<div class="line">            &quot;file name&quot;: &quot;examples/person_detection/data/person.bmp&quot;,</div>
<div class="line">            &quot;label&quot;: &quot;person&quot;,</div>
<div class="line">            &quot;regex&quot;: &quot;Person score: (\\d+\\.\\d+)% No person score: (\\d+\\.\\d+)%&quot;,</div>
<div class="line">            &quot;expr&quot;: &quot;groups[1] &gt; groups[2]&quot;,</div>
<div class="line">            &quot;qqvga size&quot;: false</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">            &quot;file name&quot;: &quot;examples/person_detection/data/no_person.bmp&quot;,</div>
<div class="line">            &quot;label&quot;: &quot;no person&quot;,</div>
<div class="line">            &quot;regex&quot;: &quot;Person score: (\\d+\\.\\d+)% No person score: (\\d+\\.\\d+)%&quot;,</div>
<div class="line">            &quot;expr&quot;: &quot;groups[1] &lt; groups[2]&quot;,</div>
<div class="line">            &quot;qqvga size&quot;: false</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">            &quot;file name&quot;: &quot;examples/person_detection/data/person.bmp&quot;,</div>
<div class="line">            &quot;label&quot;: &quot;person&quot;,</div>
<div class="line">            &quot;regex&quot;: &quot;Person score: (\\d+\\.\\d+)% No person score: (\\d+\\.\\d+)%&quot;,</div>
<div class="line">            &quot;expr&quot;: &quot;groups[1] &gt; groups[2]&quot;,</div>
<div class="line">            &quot;qqvga size&quot;: true</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">            &quot;file name&quot;: &quot;examples/person_detection/data/no_person.bmp&quot;,</div>
<div class="line">            &quot;label&quot;: &quot;no person&quot;,</div>
<div class="line">            &quot;regex&quot;: &quot;Person score: (\\d+\\.\\d+)% No person score: (\\d+\\.\\d+)%&quot;,</div>
<div class="line">            &quot;expr&quot;: &quot;groups[1] &lt; groups[2]&quot;,</div>
<div class="line">            &quot;qqvga size&quot;: true</div>
<div class="line">        }</div>
<div class="line">    ]</div>
<div class="line">}</div>
</div><!-- fragment --><p>The configuration fields are as follows:</p><ul>
<li><code>data type</code> One of the following values:<ul>
<li><code>image-grayscale</code></li>
<li><code>audio-pcm-16khz-mono-s16</code></li>
<li><code>raw-int8</code></li>
<li><code>raw-float</code></li>
</ul>
</li>
<li><code>delay after</code> Float value setting the number of seconds to delay after each test</li>
<li><code>test data</code> Array of <code>test-data-element(s)</code></li>
</ul>
<p>The <code>test-data-element</code> fields are as follows:</p><ul>
<li><code>file name</code> Name of the data file to be sent to the serial interface. This file should reside within the <code>data</code> sub-directory of the example source code.</li>
<li><code>label</code> The prediction label the model inference should produce</li>
<li><code>regex</code> A <a href="https://docs.python.org/3/library/re.html">regular-expression</a> that captures portions of the Arduino application output</li>
<li><code>expr</code> A Python expression that evaluates to a boolean. The expression should return <code>True</code> if all test conditions have been met. The expression has two variables available:<ul>
<li><code>groups</code> A list of strings and/or floats matching the <code>regex</code> capture(s).</li>
<li><code>label</code> A string containing the prediction label</li>
</ul>
</li>
<li><code>qqvga size</code> (Image element only) If <code>true</code> then resize the image data to QQVGA (160x120) dimensions. Otherwise, the image data is resized to fit the model tensor dimensions.</li>
</ul>
<p>All fields in the configuration data are <b>required</b>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>

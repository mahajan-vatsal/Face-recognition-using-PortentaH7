<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Machine Vision using Portenta H7: README</title>
<link rel="icon" href="logo.png" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Machine Vision using Portenta H7<span id="projectnumber">&#160;2</span>
   </div>
   <div id="projectbrief">This project aims to develop a face recognition-based access control system using the Arduino Portenta H7 and Vision Shield, leveraging Edge Impulse for machine learning. The system captures facial images, processes them locally using an AI model deployed on the Portenta H7 and determines access based on authorised personnel.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">README</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>TFLM Code Size FAQ<ul>
<li>Methodology to estimate code size of TFLM</li>
<li>Sample code size of the TFLM Framework</li>
<li>Tips to improve code size<ul>
<li>Only register kernels that a model needs</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md265"></a>
TFLM Code Size FAQ</h1>
<p>This document outlines basic steps to measure the code size of TFLM. On a platform based on ELF file format, the code size refers to the text section size of an ELF file. Additionally, this document outlines some common tips to keep the code size small.</p>
<p>Note that a complete application that depends on the TFLM typically would also include a TFLite model in flatbuffer and a memory arena, which are in data sections of an ELF file. Their size is an important aspect to the overall memory footprint, but not discussed in this document.</p>
<h2><a class="anchor" id="autotoc_md266"></a>
Methodology to estimate code size of TFLM</h2>
<p>Based on the <a href="https://arxiv.org/pdf/2010.08678.pdf">architecture description</a>, we further classify the source code into two categories: TFLM framework and kernels as illustrated in the below diagram:</p>
<p><img src="images/tflm_code_size_category.png" alt="TFLM code size categories" class="inline"/></p>
<p>TFLM Framework includes infrastructure such as interpreter, memory planner etc. The size of TFLM Framework is a fixed cost of using TFLM and primarily includes codes under tensorflow/lite/micro, but excludes those in tensorflow/lite/micro/kernels.</p>
<p>On the other hand, the code size contribution from the kernels depends on and scales with the model that an application uses. This contribution from the kernels mostly includes the codes in tensorflow/lite/micro/kernels as well as third party libraries.</p>
<p>To measure the size of the TFLM Framework that is independent of a model, the methodology that is adopted in this document is as follows:</p>
<ol type="1">
<li>Build the <code>baseline_memory_footprint</code> target in <code>tensorflow/lite/micro/examples/memory_footprint/</code>. Estimate its code size via a <code>size</code> command.</li>
</ol>
<ol type="1">
<li>Build the <code>interpreter_memory_footprint</code> target in <code>tensorflow/lite/micro/examples/memory_footprint/</code>. Estimate its code size via a <code>size</code> command.</li>
</ol>
<ol type="1">
<li>Subtract the two sizes from the above two steps provides the code size estimation of the TFLM Framework.</li>
</ol>
<p>Step 1 gives the code size for a "no-op application" that would typically include platform-specific initialization. We assume that this is a fixed size that is independent of TFLM.</p>
<p>Step 2 produces a binary that includes the code needed to create an interpreter instance (i.e. the TFLM framework). It explicitly avoids pulling in any kernel code such that the increase between step 2 and step 1 is a reasonable estimate of the footprint of the TFLM framework. Note that since we do not register any kernel code, the binary from step 2 can not run any actual inference.</p>
<p>The code size estimation via the above steps also include additional system libraries that need to be pulled in due the use of the TFLM.</p>
<p>A similar process can be adopted to further estimate the size of kernels. For example, the size of kernels used in keyword detection can be estimated by the following steps</p>
<ol type="1">
<li>Build the <code>keyword_benchmark</code> target in <code>tensorflow/lite/micro/benchmarks</code>. Estimate its code size via a <code>size</code> command.</li>
</ol>
<ol type="1">
<li>Subtract to get the code size difference between the <code>keyword_benchmark</code> and <code>interpreter_memory_footprint</code></li>
</ol>
<p>It may be worth noting that the above methodology will attribute the code size from <code>MicroMutableOpResolver</code> towards the code size of kernels, instead of counting them in the code size estimation of the TFLM Framework. We adopt this methodology due to its simplicity, robustness and the ability to include the contribution of system libraries.</p>
<h2><a class="anchor" id="autotoc_md267"></a>
Sample code size of the TFLM Framework</h2>
<p>The below code size number of the TFLM Framework is shown as references only.</p>
<p>For a 64 bit x86 platform, the TFLM code size obtained through the above method is 20411 bytes.</p>
<p>For an embedded bluepill ARM platform, the TFLM code size obtained through the above method is 9732 bytes.</p>
<h2><a class="anchor" id="autotoc_md268"></a>
Tips to improve code size</h2>
<h3><a class="anchor" id="autotoc_md269"></a>
Only register kernels that a model needs</h3>
<p>One common issue that leads to unnecessary large code size is forgetting to only register only kernels that a model needs and ending up registering all kernels.</p>
<p>Therefore, when moving off the exploration stage, it is better to only register for kernels that the model needs to have a smaller footprint. The following code snipet shows how to do so using the keyword detection as an example:</p>
<div class="fragment"><div class="line"><span class="comment">// Create OpResolver class with up to 6 kernel support.</span></div>
<div class="line"><span class="keyword">using </span>KeywordOpResolver = MicroMutableOpResolver&lt;6&gt;;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Avoid the usage of new by placement new</span></div>
<div class="line">uint8_t op_resolver_buffer[<span class="keyword">sizeof</span>(KeywordOpResolver)];</div>
<div class="line">KeywordOpResolver* op_resolver = <span class="keyword">new</span> (op_resolver_buffer) KeywordOpResolver();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Only add the required kernel</span></div>
<div class="line">op_resolver-&gt;AddFullyConnected(<a class="code hl_function" href="namespacetflite.html#aad4964712f02a4d3458b72d83fcdc1fe">tflite::Register_FULLY_CONNECTED_INT8</a>());</div>
<div class="line">op_resolver-&gt;AddQuantize();</div>
<div class="line">op_resolver-&gt;AddSoftmax(<a class="code hl_function" href="namespacetflite.html#afd21a15543134fd670b983bb8ca83ad1">tflite::Register_SOFTMAX_INT8_INT16</a>());</div>
<div class="line">op_resolver-&gt;AddSvdf(<a class="code hl_function" href="namespacetflite.html#a0d50d889baf2a178979bcc38e36f7dc0">tflite::Register_SVDF_INT8</a>());</div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Pass the OpResolver to the interpreter</span></div>
<div class="line">tflite::MicroInterpreter * <a class="code hl_variable" href="_inference_allocate_tensor_8cpp.html#a0d8f3bb5211083760f7c593d57adb17d">interpreter</a> = tflite::MicroInterpeter::Create(</div>
<div class="line">    g_keyword_scrambled_model_data, op_resolver, <a class="code hl_variable" href="network__tester__test_8cc.html#abf99e32bec994276b2bcf77385c93365">tensor_arena</a>, <a class="code hl_variable" href="add_2integration__tests_8cc.html#a2a246bf52e36e3cc606daab4dcea6781">kTensorArenaSize</a>, profiler);</div>
<div class="ttc" id="a_inference_allocate_tensor_8cpp_html_a0d8f3bb5211083760f7c593d57adb17d"><div class="ttname"><a href="_inference_allocate_tensor_8cpp.html#a0d8f3bb5211083760f7c593d57adb17d">interpreter</a></div><div class="ttdeci">tflite::MicroInterpreter interpreter(model, resolver, tensor_arena, kTensorArenaSize, error_reporter)</div></div>
<div class="ttc" id="aadd_2integration__tests_8cc_html_a2a246bf52e36e3cc606daab4dcea6781"><div class="ttname"><a href="add_2integration__tests_8cc.html#a2a246bf52e36e3cc606daab4dcea6781">kTensorArenaSize</a></div><div class="ttdeci">constexpr size_t kTensorArenaSize</div><div class="ttdef"><b>Definition</b> integration_tests.cc:95</div></div>
<div class="ttc" id="anamespacetflite_html_a0d50d889baf2a178979bcc38e36f7dc0"><div class="ttname"><a href="namespacetflite.html#a0d50d889baf2a178979bcc38e36f7dc0">tflite::Register_SVDF_INT8</a></div><div class="ttdeci">TfLiteRegistration Register_SVDF_INT8()</div><div class="ttdef"><b>Definition</b> svdf.cpp:220</div></div>
<div class="ttc" id="anamespacetflite_html_aad4964712f02a4d3458b72d83fcdc1fe"><div class="ttname"><a href="namespacetflite.html#aad4964712f02a4d3458b72d83fcdc1fe">tflite::Register_FULLY_CONNECTED_INT8</a></div><div class="ttdeci">TfLiteRegistration Register_FULLY_CONNECTED_INT8()</div><div class="ttdef"><b>Definition</b> fully_connected.cpp:428</div></div>
<div class="ttc" id="anamespacetflite_html_afd21a15543134fd670b983bb8ca83ad1"><div class="ttname"><a href="namespacetflite.html#afd21a15543134fd670b983bb8ca83ad1">tflite::Register_SOFTMAX_INT8_INT16</a></div><div class="ttdeci">TfLiteRegistration Register_SOFTMAX_INT8_INT16()</div><div class="ttdef"><b>Definition</b> softmax.cpp:201</div></div>
<div class="ttc" id="anetwork__tester__test_8cc_html_abf99e32bec994276b2bcf77385c93365"><div class="ttname"><a href="network__tester__test_8cc.html#abf99e32bec994276b2bcf77385c93365">tensor_arena</a></div><div class="ttdeci">uint8_t tensor_arena[TENSOR_ARENA_SIZE]</div><div class="ttdef"><b>Definition</b> network_tester_test.cc:43</div></div>
</div><!-- fragment --><p>TODO(b/201351077): add more tips to improve code size. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>

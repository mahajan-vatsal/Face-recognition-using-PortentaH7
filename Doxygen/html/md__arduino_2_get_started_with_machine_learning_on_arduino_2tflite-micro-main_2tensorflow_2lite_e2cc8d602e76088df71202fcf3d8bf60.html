<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Machine Vision using Portenta H7: porting_reference_ops</title>
<link rel="icon" href="logo.png" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Machine Vision using Portenta H7<span id="projectnumber">&#160;2</span>
   </div>
   <div id="projectbrief">This project aims to develop a face recognition-based access control system using the Arduino Portenta H7 and Vision Shield, leveraging Edge Impulse for machine learning. The system captures facial images, processes them locally using an AI model deployed on the Portenta H7 and determines access based on authorised personnel.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">porting_reference_ops</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md195"></a>
Porting Reference Ops from Lite to Micro</h1>
<p>This is a guide to porting reference ops from Lite to Micro. It explains, step-by-step, the recommended code changes and the process for submitting them for review and acceptance. The process results in multiple pull requests, or PRs. Multiple, <a href="https://google.github.io/eng-practices/review/developer/small-cls.html">small PRs</a> are easier for the project to review and merge.</p>
<p>The <a href="https://github.com/tensorflow/tflite-micro/blob/main/CONTRIBUTING.md">Micro Contributing Guidelines</a> are prerequisite reading. They cover general code health, maintainability, style, and submission, as well as how to setup a development environment. This guide contains step-by-step instructions for the specific task of porting reference ops from Lite to Micro.</p>
<ul>
<li>Porting Reference Ops from Lite to Micro<ul>
<li>1. Look for a port already in progress</li>
<li>2. Open a GitHub issue to track the port</li>
<li>3. Extract Lite's code for parsing op parameters to a function (PR1)</li>
<li>4. Extract the reference for the op to a standalone header (PR2)</li>
<li>5. Port the op from Lite to Micro (PR3)</li>
</ul>
</li>
<li>General Guidelines<ul>
<li>Check each commit for formatting, lint, and unit-test passage</li>
<li>Maintain a 1:1 correspondence between Micro and Lite versions of unit tests</li>
</ul>
</li>
<li>Notes</li>
<li>Frequently Asked Questions<ul>
<li>Can I use malloc/free or new/delete in my operator code?</li>
<li>Can I use static variable allocation in my operator code?</li>
<li>How do I allocate persistent memory?</li>
<li>When am I allowed to allocate persistent memory?</li>
<li>How do I allocate/use temporary memory?</li>
<li>When can I allocate/use temporary memory?</li>
<li>Can I resize my input/output tensors?</li>
<li>Can I change the shape of tensors in my operator code?</li>
<li>When can I change the shape of tensors in my operator code?</li>
<li>Can I modify a TfLiteTensor or TfLiteEvalTensor?</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md196"></a>
1. Look for a port already in progress</h2>
<p>Begin by searching the tflite-micro GitHub repository for issues containing the name of the op under consideration to ensure someone isn't already working on a port.</p>
<h2><a class="anchor" id="autotoc_md197"></a>
2. Open a GitHub issue to track the port</h2>
<p>Open a GitHub issue to announce your intent to port the op, and to begin a record of your work. Document the entire process of porting the op in this issue. Link constituent PRs to this issue. See the article [Providing Context][] for background on documenting your work via bug reports.</p>
<h2><a class="anchor" id="autotoc_md198"></a>
3. Extract Lite's code for parsing op parameters to a function (PR1)</h2>
<p>Now we begin changing, testing, and submitting code. This step will result in the first pull request, PR1.</p>
<ol type="1">
<li>Extract the code for parsing op parameters out of the switch statement in <a href="https://github.com/tensorflow/tensorflow/blob/d8394a6d774f5e3c02d97f1fc18ff445199db598/tensorflow/lite/core/api/flatbuffer_conversions.cc#L135"><code>ParseOpDataTfLite()</code></a> in <code><a class="el" href="flatbuffer__conversions_8cc.html">lite/core/api/flatbuffer_conversions.cc</a></code> into a standalone function, and call that function from the switch statement. This standalone function is now available to be called by the Micro op resolver, which also needs to parse the op parameters, in a future change. A simple example is <a href="https://github.com/tensorflow/tensorflow/pull/45307">PR #45307</a>, and a more complicated example is [PR #46021][].</li>
</ol>
<ol type="1">
<li><p class="startli">Use <code>clang-format</code> to make sure the code is properly formatted.</p>
<p class="startli"><code>shell clang-format --style=google -i $(git ls-files -m | grep -E '\.cc|\.h') </code></p>
</li>
</ol>
<ol type="1">
<li><p class="startli">Make sure your code is lint-free.</p>
<p class="startli"><code>shell cpplint.py $(git ls-files -m) </code></p>
</li>
</ol>
<ol type="1">
<li>Create a single commit containing the change. Observe the guidelines for good commit log messages found in the article <a href="https://testing.googleblog.com/2017/09/code-health-providing-context-with.html">Providing Context</a>. A good example is commit <a href="https://github.com/tensorflow/tensorflow/pull/45307/commits/0664214792ad2357f6224e7002661894775cb512">0664214</a>.</li>
</ol>
<ol type="1">
<li><p class="startli">Since this change modifies the op's implementation in Lite, test the change with the relevant Lite unit tests.</p>
<p class="startli"><code>shell bazel test tensorflow/lite/kernels:all </code></p>
</li>
</ol>
<ol type="1">
<li>Create and submit the PR. Write a <a href="https://google.github.io/eng-practices/review/developer/cl-descriptions.html">good PR description</a>, and be sure to link to the GitHub issue created to document the port. A good example is <a href="https://github.com/tensorflow/tensorflow/pull/45307">PR #45307</a>.</li>
</ol>
<h2><a class="anchor" id="autotoc_md199"></a>
4. Extract the reference for the op to a standalone header (PR2)</h2>
<p>Move the reference implementation of the op in <a href="https://github.com/tensorflow/tensorflow/blob/92f459e6b917fa5099ef5317d14c5100d33a86f0/tensorflow/lite/kernels/internal/reference/reference_ops.h">reference_ops.h</a> to a standalone header so that Micro can include it without including unrelated dependencies via reference_ops.h.</p>
<p>A good example is <a href="https://github.com/tensorflow/tensorflow/pull/45311">PR #45311</a>.</p>
<ol type="1">
<li>Copy an existing header from <code>tensorflow/lite/kernels/internal/reference/</code> to <code>tensorflow/lite/kernels/internal/reference/NEW_OP.H</code> to create the boilerplate. Replace <code>NEW_OP.H</code> with the name of the new operator.</li>
</ol>
<ol type="1">
<li>Move the implementation from <code>tensorflow/lite/kernels/internal/reference/reference_ops.h</code> to <code>tensorflow/lite/kernels/internal/reference/NEW_OP.H</code>.</li>
</ol>
<ol type="1">
<li>Add the new header to the build by adding to the library definitions <code>reference_base</code> and <code>legacy_reference_base</code> in the file <code>tensorflow/lite/kernels/internal/BUILD</code>. See, for example, <a href="https://github.com/tensorflow/tensorflow/pull/45311/commits/92f459e6b917fa5099ef5317d14c5100d33a86f0#diff-0b0fc9e1affece3c5a141ee9326f882876b6b958bc8b12a7c01d7540dc04983e">this change for operator FILL</a>.</li>
</ol>
<ol type="1">
<li><p class="startli">Use the program <code>clang-format</code> to make sure the code is properly formatted.</p>
<p class="startli"><code>shell clang-format --style=google -i $(git ls-files -m | grep -E '\.cc|\.h') </code></p>
<p class="startli">Do not clang-format existing code in <code><a class="el" href="namespace_b_u_i_l_d.html">BUILD</a></code> or <code>reference_ops.h</code>.</p>
</li>
</ol>
<ol type="1">
<li><p class="startli">Make sure your code is lint-free.</p>
<p class="startli"><code>shell cpplint.py $(git ls-files -m) </code></p>
<p class="startli">Do not modify code in <code><a class="el" href="namespace_b_u_i_l_d.html">BUILD</a></code> or <code>reference_ops.h</code> to satisfy <code>cpplint.py</code>.</p>
</li>
</ol>
<ol type="1">
<li>Create a single commit containing the change. Observe the guidelines for good commit log messages found in the article <a href="https://testing.googleblog.com/2017/09/code-health-providing-context-with.html">Providing Context</a>. A good example is commit <a href="https://github.com/tensorflow/tensorflow/commit/92f459e6b917fa5099ef5317d14c5100d33a86f0">92f459e</a>.</li>
</ol>
<ol type="1">
<li><p class="startli">Since this change modifies the op's implementation in Lite, test the change with the relevant Lite unit tests.</p>
<p class="startli"><code>shell bazel test tensorflow/lite/kernels:all </code></p>
</li>
</ol>
<ol type="1">
<li>Create and submit the PR. Write a <a href="https://google.github.io/eng-practices/review/developer/cl-descriptions.html">good PR description</a>, and be sure to link to the GitHub issue created to document the port. A good example is <a href="https://github.com/tensorflow/tensorflow/pull/45311">PR #45311</a>.</li>
</ol>
<h2><a class="anchor" id="autotoc_md200"></a>
5. Port the op from Lite to Micro (PR3)</h2>
<ol type="1">
<li><p class="startli">Copy the kernel and test from Lite to Micro.</p>
<p class="startli">In the first commit of this PR, copy the kernel and test from Lite to Micro without making any modifications and without adding them to the build.</p>
<p class="startli">A good example is commit <a href="https://github.com/tensorflow/tensorflow/commit/a2ca1fd7a174438f736c0435dd3e4e618612fdee">a2ca1fd</a>.</p>
<p class="startli">This copy action is in its own commit in order to create readable, reviewable diffs when modifications are made in later commits. If the files were copied and modified in one step, the modifications would not appear as a diff of the Lite version. Instead, the files would simply appear at the destination path in their final form.</p>
</li>
</ol>
<ol type="1">
<li><p class="startli">Remove Lite-specific code from copies</p>
<p class="startli">In the second commit of this PR, remove the bulk of Lite-specific code from the files copied to micro in the previous step.</p>
<p class="startli">A good example is commit <a href="https://github.com/tensorflow/tensorflow/commit/a5a87b420b87a1f832e241db3a5b724207ea700a">a5a87b4</a>.</p>
<p class="startli">This bulk-delete action is in its own commit for reasons similar to those given in the step above: to produce a more readable, reviewable diff in this step and in the next. Because the files are not yet added to the build, they need not (and obviously won't) compiler or function. What to delete now as opposed to deleting in the next commit is somewhat subjective, but make deletes in order to:</p><ul>
<li>Flatten the namespace down to <code>tflite</code>.</li>
<li>Stop resizing output tensors.</li>
<li>Remove input and output types other than <code>int8</code>, <code>int16</code>, and <code>float32</code>.</li>
<li>Stop using gmock and gtest.</li>
<li>etc.</li>
</ul>
</li>
</ol>
<ol type="1">
<li><p class="startli">Port the op and the test</p>
<p class="startli">Make the necessary changes to the micro kernel, header, and test to make the op implementation suitable for micro. Include these in the build.</p>
<p class="startli">This step requires the most creativity, and may receive the most feedback during review. Maintain good atomicity in your commits. Considering its scope, this step will consist of more than one commit. A good example is the changes made in <a href="https://github.com/tensorflow/tensorflow/pull/45647">PR #45647</a>.</p>
</li>
</ol>
<ol type="1">
<li><p class="startli">Use <code>clang-format</code> to make sure the code is properly formatted.</p>
<p class="startli"><code>shell $ clang-format --style=google -i $(git ls-files -m | grep -E '\.cc|\.h') </code></p>
<p class="startli">Do not clang-format existing code in <code><a class="el" href="namespace_b_u_i_l_d.html">BUILD</a></code> or <code>reference_ops.h</code>.</p>
</li>
</ol>
<ol type="1">
<li><p class="startli">Make sure the code is lint-free.</p>
<p class="startli"><code>shell $ cpplint.py $(git ls-files -m) </code></p>
<p class="startli">Do not modify code in <code><a class="el" href="namespace_b_u_i_l_d.html">BUILD</a></code> or <code>reference_ops.h</code> to satisfy <code>cpplint.py</code>.</p>
</li>
</ol>
<ol type="1">
<li><p class="startli">Make sure the port passes all applicable tests.</p>
<p class="startli"><code>shell $ bazel test tensorflow/lite/micro/kernels:${op}_test $ bazel test tensorflow/lite/micro/kernels:all $ make -f tensorflow/lite/micro/tools/make/Makefile test_kernel_${op}_test $ make -f tensorflow/lite/micro/tools/make/Makefile test </code></p>
<p class="startli">See the general <a href="https://github.com/tensorflow/tflite-micro/blob/main/CONTRIBUTING.md">Micro Contributing Guidelines</a> for other testing ideas, including the use of address sanitizers.</p>
</li>
</ol>
<ol type="1">
<li>Create and submit the PR. Write a <a href="https://google.github.io/eng-practices/review/developer/cl-descriptions.html">good PR description</a>, and be sure to link to the GitHub issue created to document the port. A good example is <a href="https://github.com/tensorflow/tensorflow/pull/45647">PR #45647</a>.</li>
</ol>
<h1><a class="anchor" id="autotoc_md201"></a>
General Guidelines</h1>
<h2><a class="anchor" id="autotoc_md202"></a>
Check each commit for formatting, lint, and unit-test passage</h2>
<p>Check each commit against the <a href="https://github.com/tensorflow/tflite-micro/blob/main/CONTRIBUTING.md#before-submitting-your-pr">pre-submit checklist</a> in the micro Contributing Guidelines. Specifically, make sure your code:</p>
<ol type="1">
<li>Is formatted with clang-format.</li>
</ol>
<ol type="1">
<li>Passes a lint check.</li>
</ol>
<ol type="1">
<li><p class="startli">Passes all unit tests.</p>
<p class="startli"><code>shell $ make -s -j8 -f tensorflow/lite/micro/tools/make/Makefile test </code></p>
</li>
</ol>
<p>CI runs these checks on all PRs, and will hold up your PR if any of these checks fail.</p>
<h2><a class="anchor" id="autotoc_md203"></a>
Maintain a 1:1 correspondence between Micro and Lite versions of unit tests</h2>
<p>To the extent possible, maintain a 1:1 correspondence between Micro and Lite versions of unit tests. Avoid cleanup of merely stylistic issues, e.g., by replacing the hardcoded literal <code>3.40282e+038</code> with <code>std::numeric_limits&lt;float&gt;::<a class="el" href="common__functions_8h.html#affe776513b24d84b39af8ab0930fef7f">max()</a></code>. Any changes between the Micro and Lite versions of a test put a burden on future maintainers to figure out whether the differences are actually significant or just stylistic.</p>
<h1><a class="anchor" id="autotoc_md204"></a>
Notes</h1>
<ul>
<li>There was discussion of commits vs. PRs in <a href="https://github.com/tensorflow/tensorflow/issues/45387">#45387</a>.</li>
<li><a href="https://www.tensorflow.org/lite/performance/quantization_spec">TensorFlow Lite 8-bit quantization specification</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md205"></a>
Frequently Asked Questions</h1>
<h2><a class="anchor" id="autotoc_md206"></a>
Can I use malloc/free or new/delete in my operator code?</h2>
<p>No. All memory allocation in TensorFlow Lite Micro (TFLM) is done using C++ stack based automatic allocation, or through specialized TFLM persistent and temporary allocation methods.</p>
<h2><a class="anchor" id="autotoc_md207"></a>
Can I use static variable allocation in my operator code?</h2>
<p>No. This is due to the call ordering of C++ static constructors being platform/compiler dependent.</p>
<h2><a class="anchor" id="autotoc_md208"></a>
How do I allocate persistent memory?</h2>
<p>Use <code><a class="el" href="struct_tf_lite_context.html#abad57406eef93e58a3c20bedc8458834">TfLiteContext::AllocatePersistentBuffer</a></code> to allocate persistent memory. Memory allocated by this method will remain valid throughout the lifetime of the <code><a class="el" href="classtflite_1_1_micro_interpreter.html">tflite::MicroInterpreter</a></code> instance.</p>
<p>An example code snippet looks like (<a href="../kernels/leaky_relu.cc">leaky_relu.cc</a>): </p><div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keywordtype">void</span>* LeakyReluInit(<a class="code hl_struct" href="struct_tf_lite_context.html">TfLiteContext</a>* context, <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code hl_variable" href="nano__ble33__sense__accelerometer__continuous_8ino.html#a221f01f29c6cba77d9479aba615283f5">buffer</a>, <span class="keywordtype">size_t</span> length) {</div>
<div class="line">  <a class="code hl_define" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src82599f02174ce2f1c2fd003f3eee8b73.html#aae1ef2f661f926fac4c1555e46d4c704">TFLITE_DCHECK</a>(context-&gt;<a class="code hl_variable" href="struct_tf_lite_context.html#abad57406eef93e58a3c20bedc8458834">AllocatePersistentBuffer</a> != <span class="keyword">nullptr</span>);</div>
<div class="line">  <span class="keywordflow">return</span> context-&gt;<a class="code hl_variable" href="struct_tf_lite_context.html#abad57406eef93e58a3c20bedc8458834">AllocatePersistentBuffer</a>(context, <span class="keyword">sizeof</span>(LeakyReluOpData));</div>
<div class="line">}</div>
<div class="ttc" id="a_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src82599f02174ce2f1c2fd003f3eee8b73_html_aae1ef2f661f926fac4c1555e46d4c704"><div class="ttname"><a href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src82599f02174ce2f1c2fd003f3eee8b73.html#aae1ef2f661f926fac4c1555e46d4c704">TFLITE_DCHECK</a></div><div class="ttdeci">#define TFLITE_DCHECK(condition)</div><div class="ttdef"><b>Definition</b> compatibility.h:23</div></div>
<div class="ttc" id="anano__ble33__sense__accelerometer__continuous_8ino_html_a221f01f29c6cba77d9479aba615283f5"><div class="ttname"><a href="nano__ble33__sense__accelerometer__continuous_8ino.html#a221f01f29c6cba77d9479aba615283f5">buffer</a></div><div class="ttdeci">static float buffer[EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE]</div><div class="ttdef"><b>Definition</b> nano_ble33_sense_accelerometer_continuous.ino:51</div></div>
<div class="ttc" id="astruct_tf_lite_context_html"><div class="ttname"><a href="struct_tf_lite_context.html">TfLiteContext</a></div><div class="ttdef"><b>Definition</b> common.h:704</div></div>
<div class="ttc" id="astruct_tf_lite_context_html_abad57406eef93e58a3c20bedc8458834"><div class="ttname"><a href="struct_tf_lite_context.html#abad57406eef93e58a3c20bedc8458834">TfLiteContext::AllocatePersistentBuffer</a></div><div class="ttdeci">void *(* AllocatePersistentBuffer)(struct TfLiteContext *ctx, size_t bytes)</div><div class="ttdef"><b>Definition</b> common.h:807</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md209"></a>
When am I allowed to allocate persistent memory?</h2>
<p>The <code><a class="el" href="struct_tf_lite_context.html#abad57406eef93e58a3c20bedc8458834">TfLiteContext::AllocatePersistentBuffer</a></code> method may only be called within the scope of your operator's <code>Init</code> and <code>Prepare</code> methods.</p>
<h2><a class="anchor" id="autotoc_md210"></a>
How do I allocate/use temporary memory?</h2>
<p>Use the <code><a class="el" href="struct_tf_lite_context.html#a7a3778903dc181d98fe1f10a4f6e15c9">TfLiteContext::RequestScratchBufferInArena</a></code> and <code><a class="el" href="struct_tf_lite_context.html#a79a5ae043ca55b703fe6f4cf8c571217">TfLiteContext::GetScratchBuffer</a></code> methods. The temporary memory is shared between all operators, and is only valid for your operator within the scope of your operator's <code>Invoke</code> method. Do not attempt to use temporary memory to share data between operator invocations. Temporary memory is to be used only as pre-allocated storage during the execution scope of your operator's <code>Invoke</code> method.</p>
<p>An example code snippet looks like (<a href="../kernels/add_n.cc">add_n.cc</a>): </p><div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_variable" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcbcd3bbe90c4644d53fde1ce4e312f437.html#a7a2a916a8059078c2d7a05f46c7126fd">output</a>-&gt;<a class="code hl_variable" href="struct_tf_lite_eval_tensor.html#a180bc742f14353dd12e73a872f0e0cb5">type</a> == <a class="code hl_enumvalue" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcf7df9e575f8a1f1a49c58fb0f49428b8.html#a8a47ba81bdef28b5c479ee7928a7d123a0abdf1d6cf1c5907891defe4ce746455">kTfLiteFloat32</a>) {</div>
<div class="line">    <span class="comment">// Allocate scratch buffer space for pointer to each tensor&#39;s data</span></div>
<div class="line">    <span class="comment">// and store the scratch buffer index in the node&#39;s user_data</span></div>
<div class="line">    <span class="keywordtype">int</span> <a class="code hl_variable" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src07231aa9a2b381aa3c97687e9f0d823d.html#ac05d8dbadcf0a6890de3aa3dea280352">scratch_index</a>;</div>
<div class="line">    <span class="keywordtype">size_t</span> scratch_size = <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>*) * num_inputs;</div>
<div class="line">    <a class="code hl_define" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src0ad488291f7fc2ff7a022d8a6e141a3e.html#a42da7e8a147c70f352f54ed0959365d7">TF_LITE_ENSURE_OK</a>(context, context-&gt;<a class="code hl_variable" href="struct_tf_lite_context.html#a7a3778903dc181d98fe1f10a4f6e15c9">RequestScratchBufferInArena</a>(</div>
<div class="line">                                   context, scratch_size, &amp;<a class="code hl_variable" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src07231aa9a2b381aa3c97687e9f0d823d.html#ac05d8dbadcf0a6890de3aa3dea280352">scratch_index</a>));</div>
<div class="line">    node-&gt;user_data =</div>
<div class="line">        <span class="keyword">reinterpret_cast&lt;</span>decltype(node-<span class="keyword">&gt;</span>user_data)&gt;(<a class="code hl_variable" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src07231aa9a2b381aa3c97687e9f0d823d.html#ac05d8dbadcf0a6890de3aa3dea280352">scratch_index</a>);</div>
<div class="line">  }</div>
<div class="ttc" id="a_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src07231aa9a2b381aa3c97687e9f0d823d_html_ac05d8dbadcf0a6890de3aa3dea280352"><div class="ttname"><a href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src07231aa9a2b381aa3c97687e9f0d823d.html#ac05d8dbadcf0a6890de3aa3dea280352">scratch_index</a></div><div class="ttdeci">int scratch_index</div><div class="ttdef"><b>Definition</b> add_n.cpp:46</div></div>
<div class="ttc" id="a_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src0ad488291f7fc2ff7a022d8a6e141a3e_html_a42da7e8a147c70f352f54ed0959365d7"><div class="ttname"><a href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src0ad488291f7fc2ff7a022d8a6e141a3e.html#a42da7e8a147c70f352f54ed0959365d7">TF_LITE_ENSURE_OK</a></div><div class="ttdeci">#define TF_LITE_ENSURE_OK(context, status)</div><div class="ttdef"><b>Definition</b> common.h:253</div></div>
<div class="ttc" id="a_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcbcd3bbe90c4644d53fde1ce4e312f437_html_a7a2a916a8059078c2d7a05f46c7126fd"><div class="ttname"><a href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcbcd3bbe90c4644d53fde1ce4e312f437.html#a7a2a916a8059078c2d7a05f46c7126fd">output</a></div><div class="ttdeci">TfLiteEvalTensor * output</div><div class="ttdef"><b>Definition</b> maximum_minimum.cpp:49</div></div>
<div class="ttc" id="a_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcf7df9e575f8a1f1a49c58fb0f49428b8_html_a8a47ba81bdef28b5c479ee7928a7d123a0abdf1d6cf1c5907891defe4ce746455"><div class="ttname"><a href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcf7df9e575f8a1f1a49c58fb0f49428b8.html#a8a47ba81bdef28b5c479ee7928a7d123a0abdf1d6cf1c5907891defe4ce746455">kTfLiteFloat32</a></div><div class="ttdeci">@ kTfLiteFloat32</div><div class="ttdef"><b>Definition</b> c_api_types.h:98</div></div>
<div class="ttc" id="astruct_tf_lite_context_html_a7a3778903dc181d98fe1f10a4f6e15c9"><div class="ttname"><a href="struct_tf_lite_context.html#a7a3778903dc181d98fe1f10a4f6e15c9">TfLiteContext::RequestScratchBufferInArena</a></div><div class="ttdeci">TfLiteStatus(* RequestScratchBufferInArena)(struct TfLiteContext *ctx, size_t bytes, int *buffer_idx)</div><div class="ttdef"><b>Definition</b> common.h:823</div></div>
<div class="ttc" id="astruct_tf_lite_eval_tensor_html_a180bc742f14353dd12e73a872f0e0cb5"><div class="ttname"><a href="struct_tf_lite_eval_tensor.html#a180bc742f14353dd12e73a872f0e0cb5">TfLiteEvalTensor::type</a></div><div class="ttdeci">TfLiteType type</div><div class="ttdef"><b>Definition</b> common.h:618</div></div>
</div><!-- fragment --><p> And to use the buffer: </p><div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_variable" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src07231aa9a2b381aa3c97687e9f0d823d.html#ac05d8dbadcf0a6890de3aa3dea280352">scratch_index</a> =</div>
<div class="line">    <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(<span class="keyword">reinterpret_cast&lt;</span>intptr_t<span class="keyword">&gt;</span>(node-&gt;user_data));</div>
<div class="line"><span class="keywordtype">void</span>* scratch_buffer = context-&gt;<a class="code hl_variable" href="struct_tf_lite_context.html#a79a5ae043ca55b703fe6f4cf8c571217">GetScratchBuffer</a>(context, <a class="code hl_variable" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src07231aa9a2b381aa3c97687e9f0d823d.html#ac05d8dbadcf0a6890de3aa3dea280352">scratch_index</a>);</div>
<div class="ttc" id="astruct_tf_lite_context_html_a79a5ae043ca55b703fe6f4cf8c571217"><div class="ttname"><a href="struct_tf_lite_context.html#a79a5ae043ca55b703fe6f4cf8c571217">TfLiteContext::GetScratchBuffer</a></div><div class="ttdeci">void *(* GetScratchBuffer)(struct TfLiteContext *ctx, int buffer_idx)</div><div class="ttdef"><b>Definition</b> common.h:829</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md211"></a>
When can I allocate/use temporary memory?</h2>
<p>The <code><a class="el" href="struct_tf_lite_context.html#a7a3778903dc181d98fe1f10a4f6e15c9">TfLiteContext::RequestScratchBufferInArena</a></code> method is available only within the scope of your operator's <code>Prepare</code> method. The <code><a class="el" href="struct_tf_lite_context.html#a79a5ae043ca55b703fe6f4cf8c571217">TfLiteContext::GetScratchBuffer</a></code> method is available only within the scope of your operator's <code>Invoke</code> method.</p>
<h2><a class="anchor" id="autotoc_md212"></a>
Can I resize my input/output tensors?</h2>
<p>No. The storage space for each input/output tensor is a fixed, calculated value determined at the time the TensorFlow Lite (TfLite) model converter is executed. During the <code>Init</code> phase of the <code><a class="el" href="classtflite_1_1_micro_interpreter.html">tflite::MicroInterpreter</a></code> all tensor storage is allocated by the <code><a class="el" href="classtflite_1_1_micro_interpreter.html">tflite::MicroInterpreter</a></code> instance, using the calculated values of the model converter. For more information see: <a class="el" href="md__arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-main_2tensorflow_2lite_2f970c8a04c7ccf34db0746d108b813f.html">Memory Allocation Overview</a></p>
<h2><a class="anchor" id="autotoc_md213"></a>
Can I change the shape of tensors in my operator code?</h2>
<p>Yes. The new shape must not exceed the storage space indicated by the old shape. Because tensor shape values may live in memory that is not directly writable (ex. Flash, EEPROM, ROM), a special method must be called before modification is attempted. The <code><a class="el" href="namespacetflite_1_1micro.html#a7189e8045e8205d6f29ec78a2cd9111a">tflite::micro::CreateWritableTensorDimsWithCopy</a></code> method will move the tensor shape values to guaranteed persistent writable memory.</p>
<p>An example code snippet looks like (<a href="../kernels/l2_pool_2d.cc">l2_pool_2d.cc</a>): </p><div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="comment">// the output variable is a TfLiteTensor*</span></div>
<div class="line"><a class="code hl_struct" href="struct_tf_lite_eval_tensor.html">TfLiteEvalTensor</a>* output_eval =</div>
<div class="line">      <a class="code hl_function" href="namespacetflite_1_1micro.html#aa482f3e94317cf4ae04468449ff7ee14">tflite::micro::GetEvalOutput</a>(context, node, kOutputTensor);</div>
<div class="line"><a class="code hl_define" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2src0ad488291f7fc2ff7a022d8a6e141a3e.html#a42da7e8a147c70f352f54ed0959365d7">TF_LITE_ENSURE_OK</a>(context, <a class="code hl_function" href="namespacetflite_1_1micro.html#a7189e8045e8205d6f29ec78a2cd9111a">tflite::micro::CreateWritableTensorDimsWithCopy</a>(</div>
<div class="line">                               context, <a class="code hl_variable" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcbcd3bbe90c4644d53fde1ce4e312f437.html#a7a2a916a8059078c2d7a05f46c7126fd">output</a>, output_eval));</div>
<div class="line"><a class="code hl_variable" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcbcd3bbe90c4644d53fde1ce4e312f437.html#a7a2a916a8059078c2d7a05f46c7126fd">output</a>-&gt;<a class="code hl_variable" href="struct_tf_lite_eval_tensor.html#aeaf6a5ebeb5026105c51f1f905a0091e">dims</a>-&gt;<a class="code hl_variable" href="struct_tf_lite_int_array.html#ab262dcb3609e96a3d8a5e64fccd092d6">data</a>[kBatchRank] = <a class="code hl_variable" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcb6422ba4b09c37fea36f264b4bcbc5a2.html#a33ca4260b69888f0d67521391a871b5e">batches</a>;</div>
<div class="line"><a class="code hl_variable" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcbcd3bbe90c4644d53fde1ce4e312f437.html#a7a2a916a8059078c2d7a05f46c7126fd">output</a>-&gt;<a class="code hl_variable" href="struct_tf_lite_eval_tensor.html#aeaf6a5ebeb5026105c51f1f905a0091e">dims</a>-&gt;<a class="code hl_variable" href="struct_tf_lite_int_array.html#ab262dcb3609e96a3d8a5e64fccd092d6">data</a>[kHeightRank] = <a class="code hl_variable" href="ei__fill__result__struct_8h.html#a1ef0471f3f0466a7152ee88ba4fce7d3">out_height</a>;</div>
<div class="line"><a class="code hl_variable" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcbcd3bbe90c4644d53fde1ce4e312f437.html#a7a2a916a8059078c2d7a05f46c7126fd">output</a>-&gt;<a class="code hl_variable" href="struct_tf_lite_eval_tensor.html#aeaf6a5ebeb5026105c51f1f905a0091e">dims</a>-&gt;<a class="code hl_variable" href="struct_tf_lite_int_array.html#ab262dcb3609e96a3d8a5e64fccd092d6">data</a>[kWidthRank] = <a class="code hl_variable" href="ei__fill__result__struct_8h.html#ad304736c157d6f1061c74fe1ce38c8b8">out_width</a>;</div>
<div class="line"><a class="code hl_variable" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcbcd3bbe90c4644d53fde1ce4e312f437.html#a7a2a916a8059078c2d7a05f46c7126fd">output</a>-&gt;<a class="code hl_variable" href="struct_tf_lite_eval_tensor.html#aeaf6a5ebeb5026105c51f1f905a0091e">dims</a>-&gt;<a class="code hl_variable" href="struct_tf_lite_int_array.html#ab262dcb3609e96a3d8a5e64fccd092d6">data</a>[kChannelRank] = channels_out;</div>
<div class="ttc" id="a_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcb6422ba4b09c37fea36f264b4bcbc5a2_html_a33ca4260b69888f0d67521391a871b5e"><div class="ttname"><a href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcb6422ba4b09c37fea36f264b4bcbc5a2.html#a33ca4260b69888f0d67521391a871b5e">batches</a></div><div class="ttdeci">int32_t batches</div><div class="ttdef"><b>Definition</b> fully_connected.cpp:45</div></div>
<div class="ttc" id="aei__fill__result__struct_8h_html_a1ef0471f3f0466a7152ee88ba4fce7d3"><div class="ttname"><a href="ei__fill__result__struct_8h.html#a1ef0471f3f0466a7152ee88ba4fce7d3">out_height</a></div><div class="ttdeci">const ei_learning_block_config_tflite_graph_t ei_impulse_result_t float int int out_height</div><div class="ttdef"><b>Definition</b> ei_fill_result_struct.h:209</div></div>
<div class="ttc" id="aei__fill__result__struct_8h_html_ad304736c157d6f1061c74fe1ce38c8b8"><div class="ttname"><a href="ei__fill__result__struct_8h.html#ad304736c157d6f1061c74fe1ce38c8b8">out_width</a></div><div class="ttdeci">const ei_learning_block_config_tflite_graph_t ei_impulse_result_t float int out_width</div><div class="ttdef"><b>Definition</b> ei_fill_result_struct.h:208</div></div>
<div class="ttc" id="anamespacetflite_1_1micro_html_a7189e8045e8205d6f29ec78a2cd9111a"><div class="ttname"><a href="namespacetflite_1_1micro.html#a7189e8045e8205d6f29ec78a2cd9111a">tflite::micro::CreateWritableTensorDimsWithCopy</a></div><div class="ttdeci">TfLiteStatus CreateWritableTensorDimsWithCopy(TfLiteContext *context, TfLiteTensor *tensor, TfLiteEvalTensor *eval_tensor)</div><div class="ttdef"><b>Definition</b> kernel_util.cpp:120</div></div>
<div class="ttc" id="anamespacetflite_1_1micro_html_aa482f3e94317cf4ae04468449ff7ee14"><div class="ttname"><a href="namespacetflite_1_1micro.html#aa482f3e94317cf4ae04468449ff7ee14">tflite::micro::GetEvalOutput</a></div><div class="ttdeci">TfLiteEvalTensor * GetEvalOutput(const TfLiteContext *context, const TfLiteNode *node, int index)</div><div class="ttdef"><b>Definition</b> kernel_util.cpp:80</div></div>
<div class="ttc" id="astruct_tf_lite_eval_tensor_html"><div class="ttname"><a href="struct_tf_lite_eval_tensor.html">TfLiteEvalTensor</a></div><div class="ttdef"><b>Definition</b> common.h:607</div></div>
<div class="ttc" id="astruct_tf_lite_eval_tensor_html_aeaf6a5ebeb5026105c51f1f905a0091e"><div class="ttname"><a href="struct_tf_lite_eval_tensor.html#aeaf6a5ebeb5026105c51f1f905a0091e">TfLiteEvalTensor::dims</a></div><div class="ttdeci">TfLiteIntArray * dims</div><div class="ttdef"><b>Definition</b> common.h:614</div></div>
<div class="ttc" id="astruct_tf_lite_int_array_html_ab262dcb3609e96a3d8a5e64fccd092d6"><div class="ttname"><a href="struct_tf_lite_int_array.html#ab262dcb3609e96a3d8a5e64fccd092d6">TfLiteIntArray::data</a></div><div class="ttdeci">int data[]</div><div class="ttdef"><b>Definition</b> common.h:103</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md214"></a>
When can I change the shape of tensors in my operator code?</h2>
<p>Tensor shape values can be modified any time after the <code><a class="el" href="namespacetflite_1_1micro.html#a7189e8045e8205d6f29ec78a2cd9111a">tflite::micro::CreateWritableTensorDimsWithCopy</a></code> method has been called. This means that tensor shape values can be modified within the scope of your operator's <code>Prepare</code> or <code>Invoke</code> methods. The <code><a class="el" href="namespacetflite_1_1micro.html#a7189e8045e8205d6f29ec78a2cd9111a">tflite::micro::CreateWritableTensorDimsWithCopy</a></code> method may only be called within the scope of your operator's <code>Prepare</code> method.</p>
<h2><a class="anchor" id="autotoc_md215"></a>
Can I modify a <code>TfLiteTensor</code> or <code>TfLiteEvalTensor</code>?</h2>
<p>No. The <code><a class="el" href="classtflite_1_1_micro_interpreter.html">tflite::MicroInterpreter</a></code> is the owner and manipulator of these data structures. Your code should not modify these data structures. The only directly allowed modification of tensors is to change their data values, or their shape values.</p>
<h2><a class="anchor" id="autotoc_md216"></a>
How do I fix optimized kernel unit test failures?</h2>
<p>Kernel unit tests for all optimizated kernels should pass. By default kernel unit tests for the newly added op may fail for optimized kernels as they may not have the correct references. In this case, we should let the optimized kernels fall back to the newly added reference kernels. For example, refer to this <a href="https://github.com/tensorflow/tflite-micro/pull/1274/commits/d36c9dd598dcbf352f2c60463fd0d4153703a1cd">this commit</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>

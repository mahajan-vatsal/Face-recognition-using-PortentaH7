<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Machine Vision using Portenta H7: Arm(R) Ethos(TM)-U core driver</title>
<link rel="icon" href="logo.png" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Machine Vision using Portenta H7<span id="projectnumber">&#160;2</span>
   </div>
   <div id="projectbrief">This project aims to develop a face recognition-based access control system using the Arduino Portenta H7 and Vision Shield, leveraging Edge Impulse for machine learning. The system captures facial images, processes them locally using an AI model deployed on the Portenta H7 and determines access based on authorised personnel.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Arm(R) Ethos(TM)-U core driver</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md394"></a></p>
<p>This repository contains a device driver for the Arm(R) Ethos(TM)-U NPU.</p>
<h1><a class="anchor" id="autotoc_md395"></a>
Building</h1>
<p>The source code comes with a CMake based build system. The driver is expected to be cross compiled for any of the supported Arm Cortex(R)-M CPUs, which requires the user to configure the build to match their system configuration.</p>
<p>One such requirement is to define the target CPU, normally by setting <code>CMAKE_SYSTEM_PROCESSOR</code>. <b>Note</b> that when using the toolchain files provided in <a href="https://git.mlplatform.org/ml/ethos-u/ethos-u-core-platform.git">core_platform</a>, the variable <code>TARGET_CPU</code> must be used instead of <code>CMAKE_SYSTEM_PROCESSOR</code>.</p>
<p>Target CPU is specified on the form "cortex-m&lt;nr&gt;&lt;features&gt;", for example: "cortex-m55+nodsp+nofp".</p>
<p>Similarly the target NPU configuration is controlled by setting <code>ETHOSU_TARGET_NPU_CONFIG</code>, for example "ethos-u55-128".</p>
<p>The build configuration can be defined either in the toolchain file or by passing options on the command line.</p>
<div class="fragment"><div class="line"> [bash]</div>
<div class="line">$ cmake -B build  \</div>
<div class="line">    -DCMAKE_TOOLCHAIN_FILE=&lt;toolchain&gt; \</div>
<div class="line">    -DCMAKE_SYSTEM_PROCESSOR=cortex-m&lt;nr&gt;&lt;features&gt; \</div>
<div class="line">    -DETHOSU_TARGET_NPU_CONFIG=ethos-u&lt;nr&gt;-&lt;macs&gt;</div>
<div class="line">$ cmake --build build</div>
</div><!-- fragment --><p>or when using toolchain files from <a href="https://git.mlplatform.org/ml/ethos-u/ethos-u-core-platform.git">core_platform</a></p>
<div class="fragment"><div class="line"> [bash]</div>
<div class="line">$ cmake -B build  \</div>
<div class="line">    -DCMAKE_TOOLCHAIN_FILE=&lt;core_platform_toolchain&gt; \</div>
<div class="line">    -DTARGET_CPU=cortex-m&lt;nr&gt;&lt;features&gt; \</div>
<div class="line">    -DETHOSU_TARGET_NPU_CONFIG=ethos-u&lt;nr&gt;-&lt;macs&gt;</div>
<div class="line">$ cmake --build build</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md396"></a>
Driver APIs</h1>
<p>The driver APIs are defined in <code><a class="el" href="ethosu__driver_8h.html">include/ethosu_driver.h</a></code> and the related types in <code><a class="el" href="ethosu__types_8h.html">include/ethosu_types.h</a></code>. Inferences can be invoked in two manners: synchronously or asynchronously. The two types of invocation can be freely mixed in a single application.</p>
<h2><a class="anchor" id="autotoc_md397"></a>
Synchronous invocation</h2>
<p>A typical usage of the driver can be the following:</p>
<div class="fragment"><div class="line"> [C]</div>
<div class="line">// reserve a driver to be used (this call could block until a driver is available)</div>
<div class="line">struct ethosu_driver *drv = ethosu_reserve_driver();</div>
<div class="line">...</div>
<div class="line">// run one or more inferences</div>
<div class="line">int result = ethosu_invoke(drv,</div>
<div class="line">                           custom_data_ptr,</div>
<div class="line">                           custom_data_size,</div>
<div class="line">                           base_addr,</div>
<div class="line">                           base_addr_size,</div>
<div class="line">                           num_base_addr);</div>
<div class="line">...</div>
<div class="line">// release the driver for others to use</div>
<div class="line">ethosu_release_driver(drv);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md398"></a>
Asynchronous invocation</h2>
<p>A typical usage of the driver can be the following:</p>
<div class="fragment"><div class="line"> [C]</div>
<div class="line">// reserve a driver to be used (this call could block until a driver is available)</div>
<div class="line">struct ethosu_driver *drv = ethosu_reserve_driver();</div>
<div class="line">...</div>
<div class="line">// run one or more inferences</div>
<div class="line">int result = ethosu_invoke_async(drv,</div>
<div class="line">                                 custom_data_ptr,</div>
<div class="line">                                 custom_data_size,</div>
<div class="line">                                 base_addr,</div>
<div class="line">                                 base_addr_size,</div>
<div class="line">                                 num_base_addr,</div>
<div class="line">                                 user_arg);</div>
<div class="line">...</div>
<div class="line">// do some other work</div>
<div class="line">...</div>
<div class="line">int ret;</div>
<div class="line">do {</div>
<div class="line">    // true = blocking, false = non-blocking</div>
<div class="line">    // ret &gt; 0 means inference not completed (only for non-blocking mode)</div>
<div class="line">    ret = ethosu_wait(drv, &lt;true|false&gt;);</div>
<div class="line">} while(ret &gt; 0);</div>
<div class="line">...</div>
<div class="line">// release the driver for others to use</div>
<div class="line">ethosu_release_driver(drv);</div>
</div><!-- fragment --><p>Note that if <code>ethosu_wait</code> is invoked from a different thread and concurrently with <code>ethosu_invoke_async</code>, the user is responsible to guarantee that <code>ethosu_wait</code> is called after a successful completion of <code>ethosu_invoke_async</code>. Otherwise <code>ethosu_wait</code> might fail and not actually wait for the inference completion.</p>
<h2><a class="anchor" id="autotoc_md399"></a>
Driver initialization</h2>
<p>In order to use a driver it first needs to be initialized by calling the <code>init</code> function, which will also register the handle in the list of available drivers. A driver can be torn down by using the <code>deinit</code> function, which also removes the driver from the list.</p>
<p>The correct mapping is one driver per NPU device. Note that the NPUs must have the same configuration, indeed the NPU configuration can be only one, which is defined at compile time.</p>
<h1><a class="anchor" id="autotoc_md400"></a>
Implementation design</h1>
<p>The driver is structured in two main parts: the driver, which is responsible to provide an unified API to the user; and the device part, which deals with the details at the hardware level.</p>
<p>In order to do its task the driver needs a device implementation. There could be multiple device implementation for different hardware model and/or configurations. Note that the driver can be compiled to target only one NPU configuration by specializing the device part at compile time.</p>
<h1><a class="anchor" id="autotoc_md401"></a>
Data caching</h1>
<p>For running the driver on Arm CPUs which are configured with data cache, the cache maintenance functions in the driver are exported with weakly linked symbols that should be overridden. An example implementation using the CMSIS primitives found in cachel1_armv7.h could be as below:</p>
<div class="fragment"><div class="line"> [C++]</div>
<div class="line">extern &quot;C&quot; {</div>
<div class="line">void ethosu_flush_dcache(uint32_t *p, size_t bytes) {</div>
<div class="line">    if (p)</div>
<div class="line">        SCB_CleanDCache_by_Addr(p, bytes);</div>
<div class="line">    else</div>
<div class="line">        SCB_CleanDCache();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void ethosu_invalidate_dcache(uint32_t *p, size_t bytes) {</div>
<div class="line">    if (p)</div>
<div class="line">        SCB_InvalidateDCache_by_Addr(p, bytes);</div>
<div class="line">    else</div>
<div class="line">        SCB_InvalidateDCache();</div>
<div class="line">}</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md402"></a>
Mutex and semaphores</h1>
<p>To ensure the correct functionality of the driver mutexes and semaphores are used internally. The default implementations of mutexes and semaphores are designed for a single-threaded baremetal environment. Hence for integration in environemnts where multi-threading is possible, e.g., RTOS, the user is responsible to provide implementation for mutexes and semaphores to be used by the driver.</p>
<p>The mutex and semaphore APIs are defined as weak linked functions that can be overridden by the user. The APIs are the usual ones and described below:</p>
<div class="fragment"><div class="line"> [C]</div>
<div class="line">// create a mutex by returning back a handle</div>
<div class="line">void *ethosu_mutex_create(void);</div>
<div class="line">// lock the given mutex</div>
<div class="line">void ethosu_mutex_lock(void *mutex);</div>
<div class="line">// unlock the given mutex</div>
<div class="line">void ethosu_mutex_unlock(void *mutex);</div>
<div class="line"> </div>
<div class="line">// create a (binary) semaphore by returning back a handle</div>
<div class="line">void *ethosu_semaphore_create(void);</div>
<div class="line">// take from the given semaphore</div>
<div class="line">void ethosu_semaphore_take(void *sem);</div>
<div class="line">// give from the given semaphore</div>
<div class="line">void ethosu_semaphore_give(void *sem);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md403"></a>
Begin/End inference callbacks</h1>
<p>The driver provide weak linked functions as hooks to receive callbacks whenever an inference begins and ends. The user can override such functions when needed. To avoid memory leaks, any allocations done in the <a class="el" href="ethosu__driver_8h.html#a04b34ee5d2328ecdfc7d464761f6cb7f">ethosu_inference_begin()</a> must be balanced by a corresponding free of the memory in the <a class="el" href="ethosu__driver_8h.html#abe0e7014df596c89393c3bce70c4ee0c">ethosu_inference_end()</a> callback.</p>
<div class="fragment"><div class="line"> [C]</div>
<div class="line">void ethosu_inference_begin(struct ethosu_driver *drv, void *user_arg);</div>
<div class="line">void ethosu_inference_end(struct ethosu_driver *drv, void *user_arg);</div>
</div><!-- fragment --><p>Note that the <code>void *user_arg</code> pointer passed to invoke() function is the same pointer passed to the <a class="el" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcdc91c794b43404000e39f72876c1c287.html#ab463972f482e3713c94bb345650694b7">begin()</a> and <a class="el" href="_arduino_2_get_started_with_machine_learning_on_arduino_2tflite-micro-arduino-examples-main_2srcdc91c794b43404000e39f72876c1c287.html#a4415abf9861e3883a31d588f3909eba9">end()</a> callbacks. For example:</p>
<div class="fragment"><div class="line"> [C]</div>
<div class="line">void my_function() {</div>
<div class="line">    ...</div>
<div class="line">    struct my_data data = {...};</div>
<div class="line">    int result = int ethosu_invoke_v3(drv,</div>
<div class="line">                                  custom_data_ptr,</div>
<div class="line">                                  custom_data_size,</div>
<div class="line">                                  base_addr,</div>
<div class="line">                                  base_addr_size,</div>
<div class="line">                                  num_base_addr,</div>
<div class="line">                                  (void *)&amp;data);</div>
<div class="line">    ....</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void ethosu_inference_begin(struct ethosu_driver *drv, void *user_arg) {</div>
<div class="line">        struct my_data *data = (struct my_data*) user_arg;</div>
<div class="line">        // use drv and data here</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void ethosu_inference_end(struct ethosu_driver *drv, void *user_arg) {</div>
<div class="line">        struct my_data *data = (struct my_data*) user_arg;</div>
<div class="line">        // use drv and data here</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md404"></a>
License</h1>
<p>The Arm Ethos-U core driver is provided under an Apache-2.0 license. Please see <a href="LICENSE.txt">LICENSE.txt</a> for more information.</p>
<h1><a class="anchor" id="autotoc_md405"></a>
Contributions</h1>
<p>The Arm Ethos-U project welcomes contributions under the Apache-2.0 license.</p>
<p>Before we can accept your contribution, you need to certify its origin and give us your permission. For this process we use the Developer Certificate of Origin (DCO) V1.1 (<a href="https://developercertificate.org">https://developercertificate.org</a>).</p>
<p>To indicate that you agree to the terms of the DCO, you "sign off" your contribution by adding a line with your name and e-mail address to every git commit message. You must use your real name, no pseudonyms or anonymous contributions are accepted. If there are more than one contributor, everyone adds their name and e-mail to the commit message.</p>
<div class="fragment"><div class="line"> []</div>
<div class="line">Author: John Doe &lt;john.doe@example.org&gt;</div>
<div class="line">Date:   Mon Feb 29 12:12:12 2016 +0000</div>
<div class="line"> </div>
<div class="line">Title of the commit</div>
<div class="line"> </div>
<div class="line">Short description of the change.</div>
<div class="line"> </div>
<div class="line">Signed-off-by: John Doe john.doe@example.org</div>
<div class="line">Signed-off-by: Foo Bar foo.bar@example.org</div>
</div><!-- fragment --><p>The contributions will be code reviewed by Arm before they can be accepted into the repository.</p>
<p>In order to submit a contribution push your patch to <code>ssh://&lt;GITHUB_USER_ID&gt;@review.mlplatform.org:29418/ml/ethos-u/ethos-u-core-driver</code>. To do this you will need to sign-in to <a href="https://review.mlplatform.org">review.mlplatform.org</a> using a GitHub account and add your SSH key under your settings. If there is a problem adding the SSH key make sure there is a valid email address in the Email Addresses field.</p>
<h1><a class="anchor" id="autotoc_md406"></a>
Security</h1>
<p>Please see <a class="el" href="md__face___access__inferencing_2src_2edge-impulse-sdk_2porting_2ethos-core-driver_2_s_e_c_u_r_i_t_y.html">Security</a>.</p>
<h1><a class="anchor" id="autotoc_md407"></a>
Trademark notice</h1>
<p>Arm, Cortex and Ethos are registered trademarks of Arm Limited (or its subsidiaries) in the US and/or elsewhere. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
